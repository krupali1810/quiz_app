<div class="page-title">
  <h1>Quiz Management Dashboard</h1>
  <p>Welcome, <%= current_admin_user&.name || "Admin" %>! Manage your quizzes here.</p>
</div>

<!-- Quick Stats -->
<div class="stats-grid">
  <div class="stat-card">
    <h3><%= @total_quizzes %></h3>
    <p>Total Quizzes</p>
  </div>
  <div class="stat-card">
    <h3><%= @published_quizzes %></h3>
    <p>Published</p>
  </div>
  <div class="stat-card">
    <h3><%= @draft_quizzes %></h3>
    <p>Drafts</p>
  </div>
  <div class="stat-card">
    <h3><%= @total_attempts %></h3>
    <p>Quiz Attempts</p>
  </div>
  <div class="stat-card">
    <h3><%= @completed_attempts %></h3>
    <p>Completed</p>
  </div>
</div>

<!-- Management Navigation -->
<div class="admin-nav-tabs">
  <button class="nav-tab active" onclick="showTab('quizzes')">Manage Quizzes</button>
  <button class="nav-tab" onclick="showTab('attempts')">Quiz Attempts</button>
</div>

<!-- Quiz Management Section -->
<div id="quizzes-section" class="tab-content active">
  <div class="management-actions">
    <%= link_to "Create New Quiz", new_admin_quiz_path, class: "btn btn-success" %>
    <div class="search-filter">
    <%= form_with url: admin_path, method: :get, local: true, class: "filter-form" do |form| %>
      <%= form.text_field :search, placeholder: "Search quizzes...", value: params[:search], class: "search-input" %>
      <%= form.select :status, options_for_select([['All', ''], ['Published', 'published'], ['Draft', 'draft']], params[:status]), {}, class: "filter-select" %>
      <%= form.submit "Filter", class: "btn btn-primary" %>
    <% end %>
  </div>
</div>

<!-- Quiz Table -->
<div class="quiz-table-container">
  <table class="quiz-table">
    <thead>
      <tr>
        <th>Title</th>
        <th>Creator</th>
        <th>Questions</th>
        <th>Status</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% if @quizzes.any? %>
        <% @quizzes.each do |quiz| %>
          <tr>
            <td>
              <strong><%= quiz.title %></strong>
              <% if quiz.description.present? %>
                <br><small class="text-muted"><%= truncate(quiz.description, length: 60) %></small>
              <% end %>
            </td>
            <td><%= quiz.creator.name %></td>
            <td>
              <span class="badge"><%= pluralize(quiz.questions.count, 'question') %></span>
            </td>
            <td>
              <% if quiz.is_published? %>
                <span class="status-badge status-published">Published</span>
              <% else %>
                <span class="status-badge status-draft">Draft</span>
              <% end %>
            </td>
            <td><%= quiz.created_at.strftime("%b %d, %Y") %></td>
            <td class="actions">
              <div class="dropdown">
                <button class="dropdown-toggle" onclick="toggleDropdown(this)">
                  Actions ‚ñº
                </button>
                <div class="dropdown-menu">
                  <%= link_to edit_admin_quiz_path(quiz), class: "dropdown-item" do %>
                    <span class="action-icon">‚úèÔ∏è</span> Edit Quiz
                  <% end %>
                  <%= link_to admin_quiz_questions_path(quiz), class: "dropdown-item" do %>
                    <span class="action-icon">‚ùì</span> Manage Questions
                  <% end %>
                  <%= link_to toggle_published_admin_quiz_path(quiz), 
                              method: :patch, 
                              data: { 
                                turbo_method: :patch,
                                confirm: "Are you sure you want to #{quiz.is_published? ? 'unpublish' : 'publish'} this quiz?"
                              }, 
                              class: "dropdown-item" do %>
                    <span class="action-icon"><%= quiz.is_published? ? 'üëÅÔ∏è‚Äçüó®Ô∏è' : 'üëÅÔ∏è' %></span> 
                    <%= quiz.is_published? ? 'Unpublish' : 'Publish' %>
                  <% end %>
                  <div class="dropdown-divider"></div>
                  <%= link_to admin_quiz_path(quiz), 
                              method: :delete, 
                              data: { confirm: "Are you sure? This will delete all questions and attempts." }, 
                              class: "dropdown-item danger" do %>
                    <span class="action-icon">üóëÔ∏è</span> Delete Quiz
                  <% end %>
                </div>
              </div>
            </td>
          </tr>
        <% end %>
      <% else %>
        <tr>
          <td colspan="6" class="empty-state">
            <h3>No quizzes found</h3>
            <p>Get started by creating your first quiz!</p>
            <%= link_to "Create Quiz", new_admin_quiz_path, class: "btn btn-success" %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
</div>

<!-- Quiz Attempts Section -->
<div id="attempts-section" class="tab-content">
  <div class="management-actions">
    <h3>Recent Quiz Attempts</h3>
  </div>
  
  <div class="quiz-table-container">
    <table class="quiz-table">
      <thead>
        <tr>
          <th>Participant</th>
          <th>Quiz</th>
          <th>Score</th>
          <th>Completion</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if @recent_attempts.any? %>
          <% @recent_attempts.each do |attempt| %>
            <tr>
              <td>
                <strong><%= attempt.participant_name %></strong><br>
                <small class="text-muted"><%= attempt.participant_email %></small>
              </td>
              <td><%= attempt.quiz.title %></td>
              <td>
                <span class="score-display">
                  <%= attempt.score %>/<%= attempt.total_questions %>
                  <small>(<%= number_to_percentage((attempt.score.to_f / attempt.total_questions * 100), precision: 0) %>)</small>
                </span>
              </td>
              <td>
                <% if attempt.completed_at %>
                  <span class="status-badge status-published">Completed</span>
                <% else %>
                  <span class="status-badge status-draft">In Progress</span>
                <% end %>
              </td>
              <td><%= attempt.created_at.strftime("%b %d, %Y") %></td>
              <td class="actions">
                <div class="dropdown">
                  <button class="dropdown-toggle" onclick="toggleDropdown(this)">
                    Actions ‚ñº
                  </button>
                  <div class="dropdown-menu">
                    <%= link_to admin_quiz_attempt_path(attempt), 
                                method: :delete, 
                                data: { 
                                  turbo_method: :delete,
                                  confirm: "Are you sure you want to delete this attempt?" 
                                }, 
                                class: "dropdown-item danger" do %>
                      <span class="action-icon">üóëÔ∏è</span> Delete Attempt
                    <% end %>
                  </div>
                </div>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="6" class="empty-state">
              <h3>No quiz attempts yet</h3>
              <p>Quiz attempts will appear here once users start taking quizzes.</p>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<script>
function toggleDropdown(button) {
  const dropdown = button.parentNode;
  const menu = dropdown.querySelector('.dropdown-menu');
  const isOpen = menu.classList.contains('show');
  
  // Close all other dropdowns
  document.querySelectorAll('.dropdown-menu.show').forEach(function(openMenu) {
    openMenu.classList.remove('show');
  });
  
  // Toggle current dropdown
  if (!isOpen) {
    menu.classList.add('show');
  }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
  if (!event.target.closest('.dropdown')) {
    document.querySelectorAll('.dropdown-menu.show').forEach(function(menu) {
      menu.classList.remove('show');
    });
  }
});

// Tab switching functionality
function showTab(tabName) {
  // Hide all tab contents
  document.querySelectorAll('.tab-content').forEach(function(content) {
    content.classList.remove('active');
  });
  
  // Remove active class from all tabs
  document.querySelectorAll('.nav-tab').forEach(function(tab) {
    tab.classList.remove('active');
  });
  
  // Show selected tab content
  document.getElementById(tabName + '-section').classList.add('active');
  
  // Add active class to clicked tab
  event.target.classList.add('active');
}
</script>