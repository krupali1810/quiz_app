<div class="page-title">
  <h1>Quiz Attempts Management</h1>
  <% if @quiz %>
    <p>Viewing attempts for "<%= @quiz.title %>"</p>
  <% else %>
    <p>Monitor all quiz attempts and participant performance</p>
  <% end %>
</div>

<!-- Quick Stats -->
<div class="stats-grid">
  <div class="stat-card">
    <h3><%= @total_attempts %></h3>
    <p>Total Attempts</p>
  </div>
  <div class="stat-card">
    <h3><%= @completed_count %></h3>
    <p>Completed</p>
  </div>
  <div class="stat-card">
    <h3><%= @average_score %></h3>
    <p>Average Score</p>
  </div>
  <div class="stat-card">
    <h3><%= number_to_percentage((@completed_count.to_f / @total_attempts * 100), precision: 0) if @total_attempts > 0 %></h3>
    <p>Completion Rate</p>
  </div>
</div>

<!-- Filter and Search -->
<div class="management-actions">
  <%= link_to "‚Üê Back to Dashboard", admin_path, class: "btn btn-secondary" %>
  
  <div class="search-filter">
    <%= form_with url: admin_quiz_attempts_path, method: :get, local: true, class: "filter-form" do |form| %>
      <%= form.text_field :search, placeholder: "Search by name or email...", value: params[:search], class: "search-input" %>
      <%= form.select :status, 
          options_for_select([
            ['All Attempts', ''], 
            ['Completed', 'completed'], 
            ['In Progress', 'in_progress']
          ], params[:status]), 
          {}, class: "filter-select" %>
      <%= form.submit "Filter", class: "btn btn-primary" %>
      <% if params[:search].present? || params[:status].present? %>
        <%= link_to "Clear", admin_quiz_attempts_path, class: "btn btn-secondary" %>
      <% end %>
    <% end %>
  </div>
</div>

<!-- Attempts Table -->
<%= form_with url: bulk_destroy_admin_quiz_attempts_path, method: :delete, local: true, id: "bulk-delete-form", class: "bulk-form" do |form| %>
<div class="quiz-table-container">
  <div class="bulk-actions" id="bulk-actions" style="display: none;">
    <div class="selected-info">
      <span id="selected-count">0</span> attempts selected
    </div>
    <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete the selected attempts? This action cannot be undone.')">
      üóëÔ∏è Delete Selected
    </button>
    <button type="button" class="btn btn-secondary" onclick="clearSelection()">Clear Selection</button>
  </div>
  
  <table class="quiz-table">
    <thead>
      <tr>
        <th>
          <input type="checkbox" id="select-all" onchange="toggleAllSelection()">
        </th>
        <th>Participant</th>
        <th>Quiz</th>
        <th>Score</th>
        <th>Performance</th>
        <th>Status</th>
        <th>Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% if @quiz_attempts.any? %>
        <% @quiz_attempts.each do |attempt| %>
          <tr>
            <td>
              <input type="checkbox" name="attempt_ids[]" value="<%= attempt.id %>" class="attempt-checkbox" onchange="updateBulkActions()">
            </td>
            <td>
              <div class="participant-info">
                <strong><%= attempt.participant_name %></strong><br>
                <small class="text-muted"><%= attempt.participant_email %></small>
              </div>
            </td>
            <td>
              <div class="quiz-info">
                <%= link_to attempt.quiz.title, admin_quiz_attempts_path(quiz_id: attempt.quiz.id), 
                            class: "quiz-link" %>
                <br><small class="text-muted">by <%= attempt.quiz.creator.name %></small>
              </div>
            </td>
            <td>
              <div class="score-display">
                <strong><%= attempt.score %>/<%= attempt.total_questions %></strong>
                <br><small>(<%= number_to_percentage((attempt.score.to_f / attempt.total_questions * 100), precision: 1) %>)</small>
              </div>
            </td>
            <td>
              <% percentage = (attempt.score.to_f / attempt.total_questions * 100).round %>
              <div class="performance-indicator">
                <% if percentage >= 90 %>
                  <span class="performance excellent">üåü Excellent</span>
                <% elsif percentage >= 70 %>
                  <span class="performance good">üëç Good</span>
                <% elsif percentage >= 50 %>
                  <span class="performance average">üìö Average</span>
                <% else %>
                  <span class="performance poor">üí™ Needs Improvement</span>
                <% end %>
              </div>
            </td>
            <td>
              <% if attempt.completed_at %>
                <span class="status-badge status-published">
                  Completed<br>
                  <small><%= time_ago_in_words(attempt.completed_at) %> ago</small>
                </span>
              <% else %>
                <span class="status-badge status-draft">
                  In Progress<br>
                  <small>Started <%= time_ago_in_words(attempt.created_at) %> ago</small>
                </span>
              <% end %>
            </td>
            <td>
              <div class="date-info">
                <%= attempt.created_at.strftime("%b %d, %Y") %><br>
                <small class="text-muted"><%= attempt.created_at.strftime("%I:%M %p") %></small>
              </div>
            </td>
            <td class="actions">
              <div class="dropdown">
                <button class="dropdown-toggle" onclick="toggleDropdown(this)">
                  Actions ‚ñº
                </button>
                <div class="dropdown-menu">
                  <%= link_to admin_quiz_attempts_path(quiz_id: attempt.quiz.id), class: "dropdown-item" do %>
                    <span class="action-icon">üìä</span> Quiz Attempts
                  <% end %>
                  <div class="dropdown-divider"></div>
                  <%= link_to admin_quiz_attempt_path(attempt), 
                              method: :delete, 
                              data: { 
                                turbo_method: :delete,
                                confirm: "Are you sure you want to delete this attempt? This action cannot be undone." 
                              }, 
                              class: "dropdown-item danger" do %>
                    <span class="action-icon">üóëÔ∏è</span> Delete Attempt
                  <% end %>
                </div>
              </div>
            </td>
          </tr>
        <% end %>
      <% else %>
        <tr>
          <td colspan="8" class="empty-state">
            <h3>No quiz attempts found</h3>
            <% if params[:search].present? || params[:status].present? %>
              <p>Try adjusting your search criteria or filters.</p>
              <%= link_to "Clear Filters", admin_quiz_attempts_path, class: "btn btn-primary" %>
            <% else %>
              <p>Quiz attempts will appear here once users start taking quizzes.</p>
              <%= link_to "Manage Quizzes", admin_path, class: "btn btn-primary" %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
<% end %>

<script>
function toggleDropdown(button) {
  const dropdown = button.parentNode;
  const menu = dropdown.querySelector('.dropdown-menu');
  const isOpen = menu.classList.contains('show');
  
  // Close all other dropdowns
  document.querySelectorAll('.dropdown-menu.show').forEach(function(openMenu) {
    openMenu.classList.remove('show');
  });
  
  // Toggle current dropdown
  if (!isOpen) {
    menu.classList.add('show');
  }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
  if (!event.target.closest('.dropdown')) {
    document.querySelectorAll('.dropdown-menu.show').forEach(function(menu) {
      menu.classList.remove('show');
    });
  }
});

// Bulk delete functionality
function toggleAllSelection() {
  const selectAll = document.getElementById('select-all');
  const checkboxes = document.querySelectorAll('.attempt-checkbox');
  
  checkboxes.forEach(function(checkbox) {
    checkbox.checked = selectAll.checked;
  });
  
  updateBulkActions();
}

function updateBulkActions() {
  const checkboxes = document.querySelectorAll('.attempt-checkbox:checked');
  const bulkActions = document.getElementById('bulk-actions');
  const selectedCount = document.getElementById('selected-count');
  const selectAll = document.getElementById('select-all');
  
  // Update selected count
  selectedCount.textContent = checkboxes.length;
  
  // Show/hide bulk actions
  if (checkboxes.length > 0) {
    bulkActions.style.display = 'flex';
  } else {
    bulkActions.style.display = 'none';
  }
  
  // Update select all checkbox state
  const totalCheckboxes = document.querySelectorAll('.attempt-checkbox');
  if (checkboxes.length === 0) {
    selectAll.indeterminate = false;
    selectAll.checked = false;
  } else if (checkboxes.length === totalCheckboxes.length) {
    selectAll.indeterminate = false;
    selectAll.checked = true;
  } else {
    selectAll.indeterminate = true;
  }
}

function clearSelection() {
  document.querySelectorAll('.attempt-checkbox').forEach(function(checkbox) {
    checkbox.checked = false;
  });
  document.getElementById('select-all').checked = false;
  document.getElementById('select-all').indeterminate = false;
  updateBulkActions();
}
</script>